name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build app
        run: |
          chmod +x build.sh
          ./build.sh
      
      - name: Verify app was built
        run: |
          ls -la ClipboardManager.app
          if [ ! -d "ClipboardManager.app" ]; then
            echo "Error: ClipboardManager.app not found"
            exit 1
          fi
      
      - name: Sign app (ad-hoc)
        run: |
          codesign --force --deep --sign - ClipboardManager.app
          codesign --verify --verbose ClipboardManager.app
      
      - name: Create ZIP archive
        run: |
          zip -r -y ClipboardManager.zip ClipboardManager.app
          ls -lh ClipboardManager.zip
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ClipboardManager.zip
          body: |
            ## Clipboard Manager ${{ steps.version.outputs.version }}
            
            A simple menu bar clipboard manager for macOS.
            
            ### Installation
            1. Download `ClipboardManager.zip` below
            2. Unzip the file
            3. Move `ClipboardManager.app` to your Applications folder
            4. **Remove quarantine flag** (required for unsigned apps):
               ```bash
               xattr -cr /Applications/ClipboardManager.app
               ```
            5. Launch the app - it will appear in your menu bar
            
            ### Features
            - Track up to 50 clipboard items
            - Quick access with Ctrl+Shift+P
            - Customizable keyboard shortcuts
            - Right-click menu for clear history and restart
            
            ### Requirements
            - macOS 13.0 or later
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: ClipboardManager-${{ steps.version.outputs.version }}
          path: ClipboardManager.zip
